<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Training Tracker</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f9fbfd;
      margin: 0;
      padding: 0;
      color: #1f2a63;
    }
    header {
      background: #2d2d73;
      color: #fff;
      padding: 1rem 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .container {
      max-width: 1000px;
      margin: 2rem auto;
      padding: 2rem;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
    }
    h2 {
      font-size: 1.75rem;
      margin-bottom: 0.75rem;
      color: #1f2a63;
    }
    p.welcome {
      font-size: 1rem;
      margin-bottom: 2rem;
      color: #3b3f5c;
    }
    .actions {
      text-align: right;
      margin-bottom: 1.5rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }
    th, td {
      padding: 0.85rem;
      border-bottom: 1px solid #e1e7f0;
      text-align: left;
    }
    th {
      background: #eef1f9;
      font-weight: 600;
      color: #2d2d73;
    }
    button {
      padding: 0.5rem 1rem;
      background: #0056b3;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    button:hover {
      background: #003d80;
    }
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal {
      background: #fff;
      padding: 2rem;
      border-radius: 10px;
      width: 95%;
      max-width: 500px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    }
    .modal-close {
      float: right;
      font-size: 1.5rem;
      cursor: pointer;
      color: #555;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #333;
    }
    input, select {
      width: 100%;
      padding: 0.6rem;
      margin-bottom: 1.2rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 0.95rem;
    }
    .header-btn {
      background: #ffffff;
      color: #2d2d73;
      border: 2px solid #ffffff;
      padding: 0.4rem 1rem;
      border-radius: 6px;
      font-weight: bold;
    }
    .header-btn:hover {
      background: #e0e3f0;
    }
  

body.dark {
  --bg-color: #1b1e2b;
  --text-color: #ffffff;
  background-color: var(--bg-color);
  color: var(--text-color);
}
body.dark header {
  background: #22264a;
  color: #ffffff;
}

body.dark .header-btn {
  background: #22264a;
  color: #e6e9f5;
  border-color: #22264a;
}
body.dark .container {
  background: #2a2f45;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
}
body.dark h2 { color: #e6e9f5; }
body.dark p.welcome { color: #c0c4e9; }
body.dark th {
  background: #3c4563;
  color: #ffffff;
}
body.dark td, body.dark th {
  background: #3c4563;
  color: #ffffff;
}
body.dark .modal {
  background: #333a52;
  color: #ffffff;
}
body.dark label { color: #e6e9f5; }
body.dark input {
  background: #444c66;
  color: #ffffff;
  border-color: #666;
}
body.dark button {
  background: #395ec9;
  color: #ffffff;
}
body.dark button {
  background: #395ec9;
  color: #ffffff;
}
body.dark .header-btn {
  background: #22264a;
  color: #e6e9f5;
  border-color: #22264a;
}
body.dark .header-btn:hover {
  background: #2b2f63;
}


/* === Theme-aware scrollbar styling (page-wide & modals) === */
:root {
  --sb-track: #e6eaf2;
  --sb-thumb: #b5bfd0;

  --font-size: 16px;
}
body.dark {
  --bg-color: #1b1e2b;
  --text-color: #ffffff;
  background-color: var(--bg-color);
  color: var(--text-color);
}
/* Firefox */
* {
  scrollbar-width: thin;
  scrollbar-color: var(--sb-thumb) var(--sb-track);
}
/* WebKit */
*::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}
*::-webkit-scrollbar-track {
  background: var(--sb-track);
  margin-block: 8px; /* shorten under rounded corners */
  border-radius: 10px;
}
*::-webkit-scrollbar-thumb {
  background: var(--sb-thumb);
  border-radius: 10px;
  border: 2px solid var(--sb-track); /* inset thumb slightly */
}


/* Ensure controls inherit font size */
body, button, input, select, textarea { font-size: inherit; }

/* Unified modal sizing/centering */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
.modal {
  position: relative;
  max-height: 85vh;
  min-height: 200px;
  overflow-y: auto;
}

body{ font-size: var(--font-size); }

/* === Dark mode form controls parity (matches index/settings) === */
body.dark input,
body.dark select,
body.dark textarea {
  background: #444c66;
  color: #ffffff;
  border: 1px solid #666;
}

body.dark .modal input,
body.dark .modal select,
body.dark .modal textarea {
  background: #444c66;
  color: #ffffff;
  border: 1px solid #666;
}

/* Specific input types */
body.dark input[type="text"],
body.dark input[type="email"],
body.dark input[type="password"],
body.dark input[type="search"],
body.dark input[type="number"],
body.dark input[type="tel"],
body.dark input[type="url"],
body.dark input[type="date"],
body.dark input[type="time"],
body.dark input[type="datetime-local"],
body.dark input[type="month"],
body.dark input[type="week"],
body.dark input[type="color"],
body.dark input[type="file"] {
  background: #444c66;
  color: #ffffff;
  border: 1px solid #666;
}

body.dark ::placeholder,
body.dark input::placeholder,
body.dark textarea::placeholder {
  color: #b6bfd7;
  opacity: 1;
}

body.dark select option,
body.dark select optgroup {
  background: #2a2f45;
  color: #ffffff;
}

body.dark input:focus,
body.dark select:focus,
body.dark textarea:focus {
  outline: 2px solid #8faaff;
  border-color: #8faaff;
  box-shadow: 0 0 0 3px rgba(143,170,255,0.2);
}

body.dark input:disabled,
body.dark select:disabled,
body.dark textarea:disabled {
  background: #3a415a;
  color: #b6bfd7;
  border-color: #555;
  cursor: not-allowed;
  opacity: .9;
}

/* Checkboxes and radios */
body.dark input[type="checkbox"],
body.dark input[type="radio"] {
  accent-color: #8faaff;
}

/* Range sliders */
body.dark input[type="range"]::-webkit-slider-runnable-track {
  background: #2a2f45;
  border: 1px solid #666;
}
body.dark input[type="range"]::-webkit-slider-thumb {
  background: #8faaff;
}
body.dark input[type="range"]::-moz-range-track {
  background: #2a2f45;
  border: 1px solid #666;
}
body.dark input[type="range"]::-moz-range-thumb {
  background: #8faaff;
}

/* Validation state hooks (if used) */
body.dark .is-invalid,
body.dark input.is-invalid,
body.dark select.is-invalid,
body.dark textarea.is-invalid {
  border-color: #e86b6b;
  box-shadow: 0 0 0 3px rgba(232,107,107,0.2);
}

</style>
</head>
<body>
  <header>
    <h1 style="font-size: 1.5rem; font-style: italic; font-weight: bold;">TrainingTrackerâ˜…</h1>
    <a href="index.html"><button class="header-btn">Back to Dashboard</button></a>
  </header>

  <div class="container">
    <p class="welcome">Welcome to the Training Tracker page! Here you can keep track of your employees' training progress, including certifications, classes, and orientations.</p>
    <h2>Employee Training Status</h2>
    <div class="actions">
      <button onclick="openModal()">Add Training</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="training-body"></tbody>
    </table>
  </div>

  <!-- View details modal -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal" style="max-height:60vh; overflow-y:auto;">
      <span class="modal-close" id="modal-close">&times;</span>
      <h3>Training Details</h3>
      <div id="modal-content"></div>
      <div style="display:flex; justify-content: space-between; align-items: center;">
        <h3 style ="position:relative;">Participants <span id="participant-count"></span>
          <button id="edit-btn">Edit</button>
        </h3>
      </div>
      <table id="participant-table">
        <thead>
          <th>Name</th>
          <th>Progress</th>
          <th>P/F</th>
          <th>Date Completed</th>
          <th>Rating</th>
        </thead>
        <tbody id="participant-content"></tbody>
      </table>
    </div>
  </div>

  <!-- Edit Employee Modal -->
  <div class="modal-overlay" id="edit-modal-overlay">
    <div class="modal">
      <span class="modal-close" id="edit-modal-close">&times;</span>
      <h3>Edit Training</h3>
      <form id="edit-form">
        <table id="edit-form-table">
          <tr>
            <td>
              <span>ID:</span>
            </td>
            <td>
              <span id="edit-id"></p>
            </td>
          </tr>
          <tr>
            <td>
              <label for="edit-name">Name:</label>
            </td>
            <td>
              <input type="text" id="edit-name" required>
            </td>
          </tr>
          <tr>
            <td>
              <label for="edit-type">Type:</label>
            </td>
            <td>
              <select id="edit-type">
                <option value="Course">Course</option>
                <option value="Certification">Certifictaion</option>
                <option value="Orientation">Orientation</option>
              </select>            
            </td>
          </tr>
          <tr>
            <td>
              <label for="edit-duration">Duration:</label>
            </td>
            <td>
              <input type="number" min="1" id="edit-duration" required></type>
            </td>
          </tr>
          <tr>
            <td>
              <label for="edit-duration-type">Type:</label>
            </td>
            <td>
              <select id="edit-duration-type" required>
                <option value="days">Days</option>
                <option value="weeks">Weeks</option>
                <option value="months">Months</option>
                <option value="annually">Annually</option>
              </select>            
            </td>
          </tr>
          <tr>
            <td>
              <label for="edit-start-date">Start Date:</label><br><br>
            </td>
            <td>
              <input type="date" id="edit-start-date">
            </td>
          </tr>
          <tr>
            <td>
              <label for="edit-end-date">End Date:</label><br><br>
            </td>
            <td>
              <input type="date" id="edit-end-date">
            </td>
          </tr>
          <tr>
            <td>
              <label for="edit-required">Required:</label>
            </td>
            <td>
              <input type="checkbox" id="edit-required">
            </td>
          </tr>
          <tr>
            <td>
              <label for="edit-status">Status:</label>
            </td>
            <td>
              <select id="edit-status">
                <option value="Pending">Pending</option>
                <option value="In-Progress">In-Progress</option>
                <option value="Completed">Completed</option>
                <option value="Cancelled">Cancelled</option>
              </select>
            </td>
          </tr>
          <tr>
            <td>
              <button type="submit">Save</button>
            </td>
          </tr>
        </table>
      </form>
    </div>
  </div>

  <div class="modal-overlay" id="modal">
    <div class="modal">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <h3 style="margin-bottom: 1rem;">Add Training</h3>
      <form id="training-form">
        <label for="name">Name:</label>
        <input type="text" id="name" required />

        <label for="type">Type:</label>
        <select id="type">
          <option value="Class">Class</option>
          <option value="Certification">Certification</option>
          <option value="Orientation">Orientation</option>
        </select>

        <label for="duration">Duration:</label>
        <input type="number" min="1" id="duration" required />

        <label for="duration-type">Type:</label>
        <select id="duration-type" required>
          <option value="days">Days</option>
          <option value="weeks">Weeks</option>
          <option value="months">Months</option>
          <option value="annually">Annually</option>
        </select>

        <label for="start">Start Date:</label>
        <input type="date" id="start" required />

        <label for="end">End Date:</label>
        <input type="date" id="end" required />

        <label for="required">Required:</label>
        <input type="checkbox" id="required" />

        <label for="status">Status:</label>
        <select id="status">
          <option value="Pending">Pending</option>
          <option value="In-Progress">In-Progress</option>
          <option value="Completed">Completed</option>
          <option value="Cancelled">Cancelled</option>
        </select>

        <button type="submit">Save</button>
      </form>
      <hr style="margin: 1.5rem 0;">
      <h4>Send Reminder Email</h4>
      <label for="reminder-frequency">Frequency:</label>
      <select id="reminder-frequency">
        <option value="weekly">Weekly</option>
        <option value="bi-weekly">Bi-Weekly</option>
        <option value="monthly">Monthly</option>
        <option value="annually">Annually</option>
        <option value="none">None</option>
      </select>
      <button onclick="sendReminders()">Send Reminder</button>
    </div>
  </div>
  <script>
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modal-content');
    const overlay = document.getElementById('modal-overlay');
    const form = document.getElementById('training-form');
    const tbody = document.getElementById('training-body');
    document.getElementById('modal-close').addEventListener('click', () => overlay.style.display = 'none');
    overlay.addEventListener('click', e => { if ( e.target === overlay ) overlay.style.display = 'none'; });

    var trainings = [];
    var participants = [];

    function openModal() {
      modal.style.display = 'flex';
      form.reset();
    }

    function closeModal() {
      modal.style.display = 'none';
    }

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      const training = {
        name: document.getElementById('name').value,
        type: document.getElementById('type').value,
        duration: parseInt(document.getElementById('duration').value),
        duration_type: document.getElementById('duration-type').value,
        start_date: document.getElementById('start').value,
        end_date: document.getElementById('end').value,
        required: document.getElementById('required').checked ? true : false,
        status: document.getElementById('status').value
      };
      addTrainingStatus(training);
      renderTrainings();
      closeModal();
    });

    async function addTrainingStatus(training) {
      try {
        const response = await fetch('/api/training/AddTrainingStatus', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(training)
        });
      } catch (error) {
        console.error('Error adding training status:', error);
      }
    }

    async function loadTrainings(list) {
      try{
        const response = await fetch(`/api/training/GetTrainingStatus`);
        const data = await response.json();
        console.log('Data returned from API', data);
        if(!response.ok){
            console.error('Error loading training sessions,', response.message);
        } else if(data.length !== 0){
            list.length = 0;     // Clear out previous list
            list.push(...data);  // Push data into new list
        } else {
          console.warn('Fetched list came back empty');
        }
      } catch(err) {
        console.error('Error fetching data: ', err);    
      }
    }

    async function renderTrainings() {
      tbody.innerHTML = '';
      trainings.forEach(t => {
        t.start_date = new Date(t.start_date).toISOString().slice(0,10);
        t.end_date = new Date(t.end_date).toISOString().slice(0,10);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.name}</td>
          <td>${t.type}</td>
          <td>${t.start_date}</td>
          <td>${t.end_date}</td>
          <td>${t.status}</td>
          <td>
            <button class="action-btn" onclick="viewDetails('${t._id}')">View</button>
            <button class="action-btn" onclick="editTraining('${t._id}')">Edit</button>
            <button class="action-btn" onclick="deleteTraining('${t._id}')">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    const editOverlay = document.getElementById('edit-modal-overlay');
    const editForm = document.getElementById('edit-form');
    document.getElementById('edit-modal-close').addEventListener('click', ()=>editOverlay.style.display='none');
    editOverlay.addEventListener('click', e => { if(e.target===editOverlay) editOverlay.style.display='none'; });

    function editTraining(id) {
      const trn = trainings.find(t => t._id === id);

      document.getElementById('edit-id').innerText = trn._id;
      document.getElementById('edit-name').value = trn.name;
      document.getElementById('edit-type').value = trn.type;
      document.getElementById('edit-duration').value = trn.duration;
      document.getElementById('edit-duration-type').value = trn.duration_type;
      document.getElementById('edit-start-date').value = trn.start_date;
      document.getElementById('edit-end-date').value = trn.end_date;
      document.getElementById('edit-required').checked = trn.required;
      document.getElementById('edit-status').value = trn.status;
      editOverlay.style.display = 'flex';
    }

    editForm.addEventListener('submit', t => {
      t.preventDefault();
      const id = document.getElementById('edit-id').innerText; // Get the ID from the training object;
      const trn = trainings.find(t => t._id === id);
      trn.name = document.getElementById('edit-name').value;
      trn.type = document.getElementById('edit-type').value;
      trn.duration = parseInt(document.getElementById('edit-duration').value);
      trn.duration_type = document.getElementById('edit-duration-type').value;
      trn.start_date = document.getElementById('edit-start-date').value;
      trn.end_date = document.getElementById('edit-end-date').value;
      trn.required = document.getElementById('edit-required').checked ? true : false;
      trn.status = document.getElementById('edit-status').value;
      
      (async () => {
        await putUpdatedTraining(trn);
        console.log('Post update training values:', trn);
        loadTrainings(trainings); // Refresh training list after edit);
        renderTrainings(); // Re-render the training list
      editOverlay.style.display = 'none';
      })();
    });

    async function putUpdatedTraining(trn) {
      try {
        const response = await fetch(`/api/training/UpdateTrainingStatus/${trn._id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(trn)
        });
        console.log('JSON String submitted: ', JSON.stringify(trn));

        if (!response.ok) throw new Error('Failed to update training');
        console.log('Training updated successfully:', trn);
      } catch (error) {
        console.error('Error updating training:', error);
      }
    }

    async function viewDetails(id) {
      const trn = trainings.find(t => t._id === id);
      if (trn) {
        console.log('Viewing details for training:', trn);
      }
      if (!trn) {
        console.error('Training not found for ID:', id);
        return;
      }
      modalContent.innerHTML = `
      <table>
        <tr>
          <td><strong>Name:</strong></td>
          <td>${trn.name}</td>
        </tr>
        <tr>
          <td><strong>Type:</strong></td>
          <td>${trn.type}</td>
        </tr>
        <tr>
          <td><strong>Start Date:</strong></td>
          <td>${new Date(trn.start_date).toISOString().slice(0, 10)}</td>
        </tr>
        <tr>
          <td><strong>End Date:</strong></td>
          <td>${new Date(trn.end_date).toISOString().slice(0, 10)}</td>
        </tr>
        <tr>
          <td><strong>Duration:</strong></td>
          <td>${trn.duration} ${trn.duration_type}</td>
        </tr>
        <tr>
          <td><strong>Required:</strong></td>
          <td>${trn.required ? 'Yes' : 'No'}</td>
        </tr>
        <tr>
          <td><strong>Status:</strong></td>
          <td>${trn.status}</td>
        </tr>
      </table>
      `;

      overlay.style.display = 'flex';
      try {      
        await renderParticipants(trn.participants);
      } catch (err) {
        console.error('Error loading participants:', err);
      }
    }

    async function deleteTrainingRecord(id) {
      try {
        const response = await fetch(`/api/training/DeleteTrainingStatus/${id}`, {
          method: 'DELETE'
        });
        if (!response.ok) throw new Error('Failed to delete employee');
        console.log(`Training ${id} deleted successfully`);
      } catch (error) {
        console.error('Error deleting training:', error);
      }
    }

    async function getEmployeeName(empl_id) {
      try {
        const response = await fetch(`/api/employees/GetEmployees?_id=${empl_id}`);
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        const employee = await response.json();
        console.log('Employee found:', employee);
        return employee[0].employee_name || 'Unknown Employee';
      } catch (error) {
        console.error('Error fetching employee name:', error);
        return 'Unknown Employee';
      }
    }
    
    // Function to render participants in the modal
    async function renderParticipants(list, mode = 'view') {
      const tbody = document.getElementById('participant-content');
      tbody.innerHTML = '';
      if (list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No participants found.</td></tr>';
        return;
      } else {
        document.getElementById('participant-count').innerText = `(${list.length})`;
        console.log('Mode: ', mode);
        if (document.getElementById('edit-btn')) {
          document.getElementById('edit-btn').addEventListener('click', () => {
            mode = 'edit';
            console.log('Edit button clicked, mode set to:', mode);
            renderParticipants(list, mode); // Re-render participants in edit mode
          });
        }
        // Create placeholder rows while fetching names
        list.forEach(p => {
          const row = document.createElement('tr');
          row.id = `row-${p.empl_id}`;
          row.innerHTML = `
            <td>Loading...</td>
            `;
            tbody.appendChild(row);
        });
        if(mode === 'view'){
          list.forEach(p => {
            console.log('Employee ID:', p.empl_id);
            console.log('Participant:', p);
            (async () => { const empName = await getEmployeeName(p.empl_id)
            const row = document.getElementById(`row-${p.empl_id}`); // Update placeholder row when data is returned
            row.innerHTML = `
              <td>${empName}</td>
              <td>${p.progress}</td>
              <td>${p.pass_fail}</td>
              <td>${p.date_completed ? new Date (p.date_completed).toISOString().slice(0, 10) : 'In progress'}</td>
              <td>${p.user_rating}</td>
              `;
            })().catch(err => { console.error('Error fetching employee name:', err);})
          });
        } else if (mode === 'edit') {
          list.forEach(p => {
              (async () => { const empName = await getEmployeeName(p.empl_id)
              const row = document.getElementById(`row-${p.empl_id}`);
              row.innerHTML = `
                <td>${empName}</td>
                <td>
                  <input type="text" value="${p.progress}" id="progress-${p.empl_id}" style="width: 25px;">
                </td>
                <td>
                  <select id="pass-fail-${p.empl_id}" style="width: 100%;">
                    <option value="Pass" ${p.pass_fail === 'Pass' ? 'selected' : ''}>Pass</option>
                    <option value="Fail" ${p.pass_fail === 'Fail' ? 'selected' : ''}>Fail</option>
                  </select>
                </td>
                <td>
                  <input type="date" value="${p.date_completed || ''}" id="date-completed-${p.empl_id}" style="width: 100%;">
                </td>
                <td>
                  <input type="number" min="1" max="5" value="${p.user_rating}" id="rating-${p.empl_id}" style="width: 25px;">
                </td>
              `;
            })().catch(err => { console.error('Error fetching employee name:', err);})
          });
        }
      }
    }

    function deleteTraining(index) {
      if (confirm('Delete this training record?')) {
        trainings.splice(index, 1);
        renderTrainings();
      }
    }

    function sendReminders() {
      const frequency = document.getElementById('reminder-frequency').value;
      const incomplete = trainings.filter(t => t.status !== 'Completed');
      if (incomplete.length === 0) {
        alert('No incomplete trainings to send reminders for.');
        return;
      }
      alert(`Sending ${frequency} reminder emails for ${incomplete.length} training(s) that are 50% or less completed.`);
    }

    window.onload = async () => {
      await loadTrainings(trainings);  // Populate trainings list      
      // console.log('Trainings returned: ', trainings);
      await renderTrainings();                  // Render list into table
    };
  </script>


<script>
  function applyThemeAndFontFromStorage(){
    const theme = localStorage.getItem('rt_theme');
    document.body.classList.toggle('dark', theme === 'dark');
  }
  // Apply on load
  document.addEventListener('DOMContentLoaded', applyThemeAndFontFromStorage);
  // Respond live if Settings updates localStorage in another tab/window
  window.addEventListener('storage', function(e){
    if(e.key === 'rt_theme') applyThemeAndFontFromStorage();
  });
</script>


<script>
  (function(){
    // Keys used across pages
    const THEME_KEY = 'rt_theme';
    const FONT_KEY  = 'rt_font';

    function setTheme(theme){
      const t = (theme === 'dark') ? 'dark' : 'light';
      document.body.classList.remove('light','dark');
      document.body.classList.add(t);
    }
    function setFontSize(size){
      const val = size || getComputedStyle(document.documentElement).getPropertyValue('--font-size') || '16px';
      // Apply at root so everything inherits
      document.documentElement.style.setProperty('--font-size', val.trim());
    }

    window.applyThemeAndFontFromStorage = function(){
      try {
        const theme = localStorage.getItem(THEME_KEY) || null;
        const font  = localStorage.getItem(FONT_KEY) || null;
        if (theme) setTheme(theme);
        if (font)  setFontSize(font);
      } catch(e){ console.warn('Could not apply theme/font from storage:', e); }
    };

    window.persistThemeAndFont = function(theme, font){
      try {
        if (theme) localStorage.setItem(THEME_KEY, theme);
        if (font)  localStorage.setItem(FONT_KEY, font);
        if (theme) setTheme(theme);
        if (font)  setFontSize(font);
      } catch(e){ console.warn('Could not persist theme/font:', e); }
    };

    document.addEventListener('DOMContentLoaded', applyThemeAndFontFromStorage);
    window.addEventListener('storage', function(e){
      if (e.key === THEME_KEY || e.key === FONT_KEY) applyThemeAndFontFromStorage();
    });
  })();
</script>
